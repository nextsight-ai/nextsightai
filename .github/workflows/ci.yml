name: CI Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/ci.yml'

jobs:
  # Frontend Tests & Lint (runs only when frontend files change)
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'frontend/'))
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Check for frontend changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'

      - name: Install dependencies
        if: steps.changes.outputs.frontend == 'true'
        run: npm ci

      - name: Security Audit (npm)
        if: steps.changes.outputs.frontend == 'true'
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Run ESLint (includes security rules)
        if: steps.changes.outputs.frontend == 'true'
        run: npm run lint
        continue-on-error: true

      - name: TypeScript type check
        if: steps.changes.outputs.frontend == 'true'
        run: npx tsc --noEmit

      - name: Build
        if: steps.changes.outputs.frontend == 'true'
        run: npm run build

  # Backend Tests & Lint (runs only when backend files change)
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for backend changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'

      - name: Setup Python
        if: steps.changes.outputs.backend == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        if: steps.changes.outputs.backend == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov black bandit pip-audit

      - name: Security Audit - Dependency Vulnerabilities (pip-audit)
        if: steps.changes.outputs.backend == 'true'
        run: pip-audit
        continue-on-error: true

      - name: Security Audit - Code Security (Bandit)
        if: steps.changes.outputs.backend == 'true'
        run: bandit -r app/ -ll -f txt
        continue-on-error: true

      - name: Run Black (code formatting)
        if: steps.changes.outputs.backend == 'true'
        run: black --check --line-length 120 app/
        continue-on-error: true

      - name: Run Tests with Coverage
        if: steps.changes.outputs.backend == 'true'
        run: pytest --cov=app --cov-report=xml --cov-report=term
        continue-on-error: true

      - name: Upload Coverage to Codecov
        if: steps.changes.outputs.backend == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  # Docker Build Test (runs only when Docker-related files change)
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: always() && (needs.frontend.result == 'success' || needs.backend.result == 'success' || needs.frontend.result == 'skipped' || needs.backend.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'frontend/Dockerfile'
            backend:
              - 'backend/**'
              - 'backend/Dockerfile'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend Docker image
        if: steps.changes.outputs.frontend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          tags: nextsight-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Backend Docker image
        if: steps.changes.outputs.backend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: nextsight-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
